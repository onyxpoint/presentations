<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Lifecycle of a Puppet Module</title>

    <meta name="description" content="A framework for easily creating beautiful presentations using HTML">
    <meta name="author" content="Hakim El Hattab">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/onyx.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>
      <!-- Added a global top level header -->

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="reveal">
      <div class="topbar">
          <h1 class="titulo">Lifecycle of a Puppet Module</h1><image class="logo" src="images/header_logo.png">
      </div>

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
<section data-markdown> <!-- ========================================= -->
  <script type="text/template">
### Overview

- Puppet modules are self-contained bundles of code and data.
- Nearly all logic (besides ```site.pp```) should be in a module.
- You can write your own modules or download pre-built ones from [Puppet Forge](http://forge.puppetlabs.com/).
  </script>
</section>

<section> <!-- ========================================= -->
  <section data-markdown>
    <script type="text/template">
### Finding modules
#### Local system
```sh
puppet module list
```


#### On Puppet Forge
```sh
# search
puppet module search SEARCH_TERM

puppet module install PACKAGE
```
    </script>
  </section>
</section>



<section> <!-- ========================================= -->
  <section data-markdown>
    <script type="text/template"> <!---------- -->
### Installing a module
#### From PuppetForge
```sh
puppet module search motd
### Notice: Searching https://forgeapi.puppetlabs.com ...
### NAME                      DESCRIPTION                                       AUTHOR            KEYWORDS
### alkivi-motd               Controls motd file on unix system                 @alkivi           debian motd
### ericsson-motd             Manage MOTD                                       @ericsson         motd issue banner
### ...
### puppetlabs-motd           A simple module to demonstrate managing /etc/...  @puppetlabs       testing


puppet module install puppetlabs-motd
```
    </script>
  </section>


  <section data-markdown>
    <script type="text/template"> <!---------- -->
### Installing a module
#### From a local archive
```sh
puppet module install --ignore-dependencies \
                   /usr/src/forge/puppetlabs-apache-1.2.0.tar.gz
```
    </script>
  </section>
</section>



<section> <!-- ========================================= -->
  <section data-markdown> <!---------- -->
    <script type="text/template">
### Module Anatomy 
#### manifests
```
./
├── manifests/
    └── init.pp
```
    </script>
  </section>

  <section data-markdown> <!---------- -->
    <script type="text/template">
### Module Anatomy
#### Files

```
./
├── manifests/
│   └── init.pp
│
├── files/
│   └── (any files you want to distribute)
├── templates/
│   └── (.erb templates)
```
    </script>
  </section>

  <section data-markdown> <!---------- -->
    <script type="text/template">
### Module Anatomy
#### Metadata
```
./
├── manifests/
│   └── init.pp
├── files/
├── templates/
│
├── metadata.json
├── README.md
```
    </script>
  </section>
  <section data-markdown> <!---------- -->
    <script type="text/template">
### Module Anatomy
#### advanced
```
./
├── manifests/
│   └── init.pp
├── files/
├── templates/
│
├── facts.d/
├── lib/
│   ├── facter/
│   └── puppet/
├── spec/
└── tests/
```
    </script>
  </section>


  <section data-markdown> <!---------- -->
    <script type="text/template">
### Module Anatomy
#### advanced and fun (<a href="http://www.meetup.com/Baltimore-Puppet-User-Group/events/220427599/">next talk</a>)
```
./
└── lib/
    ├── facter/
    └── puppet/
        ├── parser/
        │   └── functions/ 
        ├── provider/      # shit gets real right here!
        └── type/         
```
    </script>
  </section>
</section>



<section> <!-- ========================================= -->
  <section data-markdown>
    <script type="text/template">
### Using modules 
#### Syntax
In `foo/manifests/init.pp`:
```puppet
class foo
{
  resource{ 'label':
    attribute => 'value',
  }
}
```
    </script>
  </section>
  

  <section data-markdown>
    <script type="text/template">
### Using modules 
#### Syntax
In `foo/manifests/bar.pp`:
```puppet
class foo::bar( 
  $parameter => 'value',
)
{
  include 'stdlib'
  validate_string( $parameter )

  resource{ 'label':
    attribute => $parameter,
  }
}
```
    </script>
  </section>
</section>


<section> <!-- ========================================= -->
  <section data-markdown>
    <script type="text/template">
### Using modules 
#### applying (masterless)
```puppet
puppet apply foo/manifests/init.pp
```

```puppet
puppet apply -e "include 'foo'"
```

```puppet
puppet apply -e "class {'foo: attribute => value }"
```
    </script>
  </section>

  <section data-markdown>
    <script type="text/template">
### Using modules 
#### applying (with puppet master)
```puppet
puppet agent -t

puppet agent -t --noop  # dry-run    
```

- Needs some form of classification
  - ```node{}```
  - Hiera
  - ENC (e.g., Foreman, the PE console)
    </script>
  </section>
</section>


<section> <!-- ========================================= -->
  <section data-markdown>
    <script type="text/template">
### Using modules 
#### classification (in puppet code)
```puppet
node default {
  class{ 'foo': attribute => 'value }
}
```

This is *not* recommended:

- nails classification to puppet logic
- circumvents more flexible sources such as ENCs and Hiera

    </script>
  </section>


  <section data-markdown>
    <script type="text/template">
### Using modules 
#### classification (via ENC)
- examples vary based on the ENC
- PE console includes a sophisticated ENC 
- ENCs have precedence over Hiera
    </script>
  </section>


  <section data-markdown>
    <script type="text/template">
### Using modules 
#### classification (via hiera)
In puppet:
```puppet
# second argument is default in case Hiera lookup fails
hiera_include( 'classes', [] )
```

In hieradata:
```yaml
---
classes:
  - 'foo'
  - 'bar'
```
    </script>
  </section>
</section>
  
<section> <!-- ========================================= -->
  <section data-markdown>
    <script type="text/template">
### Using modules 
#### parameter precedence
- Puppet can assign values for class parameters in multiple places.  
- When the same parameter is assigned in two or more places, the precedence is the following:

**ENC > Hiera > Default Class Parameters**
    </script>
    </section>
</section>

<section> <!-- ========================================= -->
  <section data-markdown>
    <script type="text/template">
### Building Modules
#### Before you start:
- **know how to build what you want by hand**
- think about the API
  - class parameters 
  - cross-module dependencies
    </script>
  </section>

  <section data-markdown>
    <script type="text/template">
### Building Modules
#### Starting
- Create directories / files by hand

- Puppet Module tool:
  - ```
  puppet module generate orgname-modulename
  ```
  - Generates useful artifacts:
    - ```metadata.json``` (for [PuppetForge](https://forge.puppetlabs.com/) )
    - smoke and spec-testing skeletons
    - ```README.md``` (for [GitHub](https://github.com/), [GitLab](https://about.gitlab.com/), [BitBucket](https://bitbucket.org))
    </script>
  </section>
</section>


<section> <!-- ========================================= -->
  <section data-markdown>
    <script type="text/template">
### Maintenance considerations
#### documentation
- README.md (used with [GitHub](https://github.com))
- Source comments (used with ```puppet doc```) (used with ```puppet doc```)
    </script>
  </section>

  <section data-markdown>
    <script type="text/template">
### Maintenance considerations
#### version control
- control modules like any other code
- PuppetLabs' recommendation is one repo per module
- branches can be used to dynamically create [directory environments](https://docs.puppetlabs.com/puppet/latest/reference/environments_configuring.html) using tools like [r10k](https://github.com/puppetlabs/r10k)
    </script>
  </section>

  <section data-markdown>
    <script type="text/template">
### Maintenance considerations
#### testing (simple)
- syntax checking
  - ```puppet lint FILE```
  - ```puppet parser validate FILE```

- "smoke" testing
    - ```puppet apply --noop```, see if the catalog compiles
    - ```tests/``` directory
    </script>
  </section>

  <section data-markdown>
    <script type="text/template">
### Maintenance considerations
#### testing (automated)
- unit testing
    - [puppet-rspec](http://rspec-puppet.com/tutorial/)
    - ``` spec/``` directory
    - ```puppetlab_spec_helper``` gem + ```.fixtures.yml```
- acceptance testing
    - [serverspec](http://serverspec.org/)
    - [beaker](https://github.com/puppetlabs/beaker)
    - [r10k](https://github.com/puppetlabs/r10k) + dynamic directory environments
    </script>
  </section>
</section>


<section> <!-- ========================================= -->
  <section data-markdown>
    <script type="text/template">
### Reusing Modules
#### Parameters
- have defaults when possible
- limit ::params pattern to parameter defaults
- class inheritance
</script>
  </section>

  <section data-markdown>
    <script type="text/template">
### Reusing Modules
#### Hiera
- never require Hiera, always allow it
- limit hiera function calls to parameters
  - consider ramifications of lookup defaults
    </script>
  </section>


  <section data-markdown>
    <script type="text/template">
### Reusing Modules
#### Preparing modules for PuppetForge
- ```metadata.json```
- Public repository
    </script>
  </section>

  <section data-markdown>
    <script type="text/template">
### Reusing Modules
#### Composition
- Roles and Profiles (advanced reuse pattern)
    </script>
  </section>
</section>


<section>
  <section data-markdown>
    <script type="text/template">
### Further discussion
- Beginner’s guide:            https://docs.puppetlabs.com/guides/module_guides/bgtm.html
- Coding guidelines:           https://docs.puppetlabs.com/guides/style_guide.html
- Module Fundamentals:         https://docs.puppetlabs.com/puppet/latest/reference/modules_fundamentals.html
- PuppetLabs’ module tutorial: https://docs.puppetlabs.com/learning/modules1.html#the-modulepath

    </script>
  </section>
</section>

<section style="text-align: left;">
  <h1>THE END</h1>
  <!--p>
    - <a href="http://slides.com">Try the online editor</a> <br>
    - <a href="https://github.com/hakimel/reveal.js">Source code &amp; documentation</a>
  </p-->
</section>

      </div>

    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true },
          { src: 'plugin/notes/notes.js', async: true }
        ]
      });

    </script>

  </body>
</html>
